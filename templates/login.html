<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login ‚Äî Transcript Intelligence</title>
    <meta name="description" content="Sign in to your Transcript Intelligence Dashboard.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <!-- Google Identity Services (loaded only when client ID is available) -->
    {% if google_client_id %}
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    {% endif %}
</head>

<body>
    <div class="app">
        <div class="login-container">
            <!-- Logo -->
            <div class="login-logo">
                <div class="logo-icon logo-icon-lg">
                    <svg width="44" height="44" viewBox="0 0 28 28" fill="none">
                        <rect width="28" height="28" rx="8" fill="url(#logo-grad-login)" />
                        <path d="M8 20V10L14 6L20 10V20L14 16L8 20Z" fill="white" fill-opacity="0.9" />
                        <defs>
                            <linearGradient id="logo-grad-login" x1="0" y1="0" x2="28" y2="28">
                                <stop stop-color="#6366f1" />
                                <stop offset="1" stop-color="#8b5cf6" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h1 class="login-title">Transcript Intelligence</h1>
                <p class="login-subtitle">Math Tutoring Growth Engine</p>
            </div>

            <!-- Role tabs -->
            <div class="login-card" id="login-card">
                <div class="login-tabs">
                    <button class="login-tab active" id="tab-tutor" onclick="switchTab('tutor')">
                        üë®‚Äçüè´ I'm a Tutor
                    </button>
                    <button class="login-tab" id="tab-parent" onclick="switchTab('parent')">
                        üë®‚Äçüë©‚Äçüëß I'm a Parent
                    </button>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- TUTOR SECTION           -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="tutor-section">
                    {% if google_client_id %}
                    <!-- Google Sign-In -->
                    <div class="google-signin-wrapper">
                        <div id="g_id_onload" data-client_id="{{ google_client_id }}" data-callback="handleGoogleSignIn"
                            data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="filled_black"
                            data-text="signin_with" data-size="large" data-width="380">
                        </div>
                    </div>
                    <div id="google-error" class="form-error" style="display:none;"></div>
                    {% else %}
                    <!-- Dev fallback: email + password -->
                    <div class="dev-mode-badge">
                        <span>üîß Dev Mode</span> ‚Äî Google Sign-In not configured
                    </div>
                    <div class="login-tabs login-sub-tabs">
                        <button class="login-tab active" id="tab-dev-login" onclick="switchDevTab('login')">Sign
                            In</button>
                        <button class="login-tab" id="tab-dev-register" onclick="switchDevTab('register')">Sign
                            Up</button>
                    </div>

                    <!-- Dev Sign In -->
                    <form id="dev-login-form" onsubmit="handleDevLogin(event)">
                        <div class="form-group">
                            <label for="dev-email">Email</label>
                            <input type="email" id="dev-email" required placeholder="tutor@example.com"
                                autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="dev-password">Password</label>
                            <input type="password" id="dev-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                autocomplete="current-password">
                        </div>
                        <div id="dev-login-error" class="form-error" style="display:none;"></div>
                        <button type="submit" class="btn btn-primary btn-full" id="dev-login-btn">
                            <span id="dev-login-text">Sign In</span>
                            <span id="dev-login-spinner" class="btn-spinner" style="display:none;"></span>
                        </button>
                    </form>

                    <!-- Dev Register -->
                    <form id="dev-register-form" style="display:none;" onsubmit="handleDevRegister(event)">
                        <div class="form-group">
                            <label for="dev-reg-name">Full Name</label>
                            <input type="text" id="dev-reg-name" required placeholder="e.g. Dr. Sharma">
                        </div>
                        <div class="form-group">
                            <label for="dev-reg-email">Email</label>
                            <input type="email" id="dev-reg-email" required placeholder="you@example.com"
                                autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="dev-reg-password">Password</label>
                            <input type="password" id="dev-reg-password" required placeholder="Min 4 characters"
                                minlength="4" autocomplete="new-password">
                        </div>
                        <div id="dev-register-error" class="form-error" style="display:none;"></div>
                        <button type="submit" class="btn btn-primary btn-full" id="dev-register-btn">
                            <span id="dev-register-text">Create Account</span>
                            <span id="dev-register-spinner" class="btn-spinner" style="display:none;"></span>
                        </button>
                    </form>
                    {% endif %}
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- PARENT SECTION          -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="parent-section" style="display:none;">
                    <div class="parent-login-info">
                        <span class="parent-login-icon">üîì</span>
                        <p>Enter the email or WhatsApp number your child's tutor has on file. No password needed!</p>
                    </div>

                    <form id="parent-form" onsubmit="handleParentLogin(event)">
                        <div class="form-group">
                            <label for="parent-contact">Email or WhatsApp Number</label>
                            <input type="text" id="parent-contact" required
                                placeholder="e.g. parent@gmail.com or +91-98765-43210" autocomplete="email tel">
                        </div>
                        <div id="parent-error" class="form-error" style="display:none;"></div>
                        <button type="submit" class="btn btn-primary btn-full" id="parent-login-btn">
                            <span id="parent-login-text">Continue</span>
                            <span id="parent-login-spinner" class="btn-spinner" style="display:none;"></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Hint -->
            <div class="login-hint">
                {% if not google_client_id %}
                <p>Demo tutor: <strong>tutor@example.com</strong> (password: <strong>demo123</strong>)</p>
                {% endif %}
                <p>Demo parent: <strong>parent@example.com</strong> or <strong>+91-9876543210</strong></p>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ‚îÄ
        function switchTab(tab) {
            document.getElementById('tutor-section').style.display = tab === 'tutor' ? 'block' : 'none';
            document.getElementById('parent-section').style.display = tab === 'parent' ? 'block' : 'none';
            document.getElementById('tab-tutor').classList.toggle('active', tab === 'tutor');
            document.getElementById('tab-parent').classList.toggle('active', tab === 'parent');
            // Clear errors
            document.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');
        }

        function switchDevTab(tab) {
            const loginForm = document.getElementById('dev-login-form');
            const registerForm = document.getElementById('dev-register-form');
            if (loginForm) loginForm.style.display = tab === 'login' ? 'block' : 'none';
            if (registerForm) registerForm.style.display = tab === 'register' ? 'block' : 'none';
            const tabLogin = document.getElementById('tab-dev-login');
            const tabRegister = document.getElementById('tab-dev-register');
            if (tabLogin) tabLogin.classList.toggle('active', tab === 'login');
            if (tabRegister) tabRegister.classList.toggle('active', tab === 'register');
            document.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');
        }

        // ‚îÄ‚îÄ‚îÄ Google Sign-In Callback ‚îÄ‚îÄ‚îÄ
        async function handleGoogleSignIn(response) {
            const errEl = document.getElementById('google-error');
            errEl.style.display = 'none';
            try {
                const res = await fetch('/api/login/google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_token: response.credential })
                });
                const data = await res.json();
                if (res.ok) {
                    window.location.href = '/';
                } else {
                    errEl.textContent = data.error || 'Google sign-in failed';
                    errEl.style.display = 'block';
                }
            } catch (err) {
                errEl.textContent = 'Connection error. Please try again.';
                errEl.style.display = 'block';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Dev Login (fallback) ‚îÄ‚îÄ‚îÄ
        async function handleDevLogin(e) {
            e.preventDefault();
            const errEl = document.getElementById('dev-login-error');
            errEl.style.display = 'none';
            const btn = document.getElementById('dev-login-btn');
            btn.disabled = true;
            document.getElementById('dev-login-text').textContent = 'Signing in...';
            document.getElementById('dev-login-spinner').style.display = 'inline-block';

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('dev-email').value,
                        password: document.getElementById('dev-password').value
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    window.location.href = '/';
                } else {
                    errEl.textContent = data.error || 'Login failed';
                    errEl.style.display = 'block';
                }
            } catch (err) {
                errEl.textContent = 'Connection error. Please try again.';
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                document.getElementById('dev-login-text').textContent = 'Sign In';
                document.getElementById('dev-login-spinner').style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Dev Register (fallback) ‚îÄ‚îÄ‚îÄ
        async function handleDevRegister(e) {
            e.preventDefault();
            const errEl = document.getElementById('dev-register-error');
            errEl.style.display = 'none';
            const btn = document.getElementById('dev-register-btn');
            btn.disabled = true;
            document.getElementById('dev-register-text').textContent = 'Creating...';
            document.getElementById('dev-register-spinner').style.display = 'inline-block';

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('dev-reg-name').value,
                        email: document.getElementById('dev-reg-email').value,
                        password: document.getElementById('dev-reg-password').value,
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    window.location.href = '/';
                } else {
                    errEl.textContent = data.error || 'Registration failed';
                    errEl.style.display = 'block';
                }
            } catch (err) {
                errEl.textContent = 'Connection error. Please try again.';
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                document.getElementById('dev-register-text').textContent = 'Create Account';
                document.getElementById('dev-register-spinner').style.display = 'none';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Parent Login ‚îÄ‚îÄ‚îÄ
        async function handleParentLogin(e) {
            e.preventDefault();
            const errEl = document.getElementById('parent-error');
            errEl.style.display = 'none';
            const btn = document.getElementById('parent-login-btn');
            btn.disabled = true;
            document.getElementById('parent-login-text').textContent = 'Looking up...';
            document.getElementById('parent-login-spinner').style.display = 'inline-block';

            try {
                const res = await fetch('/api/login/parent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contact: document.getElementById('parent-contact').value
                    })
                });
                const data = await res.json();
                if (res.ok) {
                    window.location.href = '/';
                } else {
                    errEl.textContent = data.error || 'No matching student found. Please check with your child\'s tutor.';
                    errEl.style.display = 'block';
                }
            } catch (err) {
                errEl.textContent = 'Connection error. Please try again.';
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                document.getElementById('parent-login-text').textContent = 'Continue';
                document.getElementById('parent-login-spinner').style.display = 'none';
            }
        }
    </script>
</body>

</html>